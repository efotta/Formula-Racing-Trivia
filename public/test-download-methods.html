
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Download Test</title>
    <style>
        body { 
            font-family: system-ui, sans-serif; 
            padding: 20px; 
            background: #f8fafc; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 500; 
            font-size: 14px; 
            transition: all 0.2s; 
        }
        .primary { background: #3b82f6; color: white; }
        .primary:hover { background: #2563eb; }
        .secondary { background: #6b7280; color: white; }
        .secondary:hover { background: #4b5563; }
        .success { background: #10b981; color: white; }
        .success:hover { background: #059669; }
        .danger { background: #ef4444; color: white; }
        .danger:hover { background: #dc2626; }
        .log { 
            background: #f1f5f9; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            padding: 15px; 
            margin: 15px 0; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .log-entry { margin: 3px 0; }
        .success-log { color: #059669; }
        .error-log { color: #dc2626; }
        .info-log { color: #0ea5e9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Excel Download Test Suite</h1>
        <p>This page tests the exact same download methods used in the admin panel.</p>
        
        <h2>Test Methods</h2>
        <button class="primary" onclick="testMethod1()">Method 1: Blob Download</button>
        <button class="secondary" onclick="testMethod2()">Method 2: Direct Navigation</button>
        <button class="success" onclick="testMethod3()">Method 3: New Window</button>
        <button class="primary" onclick="testMethod4()">Method 4: Download Link</button>
        <button class="secondary" onclick="testMethod5()">Method 5: Hidden Iframe</button>
        
        <h2>Direct Access</h2>
        <a href="/api/admin/export-excel?auth=admin" class="success" style="text-decoration: none; display: inline-block;">üîó Direct Link</a>
        <a href="/api/admin/export-excel?auth=admin" target="_blank" class="primary" style="text-decoration: none; display: inline-block;">üîó Open in New Tab</a>
        <a href="/api/admin/export-excel?auth=admin" download="test-download.xlsx" class="danger" style="text-decoration: none; display: inline-block;">üîó Download Link</a>
        
        <h2>Console Log</h2>
        <div id="console" class="log"></div>
        
        <button class="secondary" onclick="clearLog()" style="margin-top: 10px;">Clear Log</button>
    </div>

    <script>
        const downloadUrl = '/api/admin/export-excel?auth=admin';
        const filename = `formula-trivia-questions-${new Date().toISOString().split('T')[0]}.xlsx`;
        
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}-log`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
            
            // Also log to browser console
            if (type === 'error') {
                console.error(message);
            } else if (type === 'success') {
                console.info(message);
            } else {
                console.log(message);
            }
        }
        
        function clearLog() {
            document.getElementById('console').innerHTML = '';
        }
        
        // Method 1: Fetch blob and create download (exact replica of admin panel)
        async function testMethod1() {
            log('üîÑ Testing Method 1: Fetch blob approach...', 'info');
            
            try {
                const response = await fetch(downloadUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer admin'
                    }
                });
                
                log(`üì° Response status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`üìã Content-Type: ${response.headers.get('content-type')}`, 'info');
                
                if (response.ok) {
                    const blob = await response.blob();
                    log(`üì¶ Blob created: ${blob.size} bytes, type: ${blob.type}`, 'success');
                    
                    if (blob.size > 0) {
                        // Create blob URL
                        const blobUrl = URL.createObjectURL(blob);
                        log(`üîó Blob URL created: ${blobUrl.substring(0, 50)}...`, 'success');
                        
                        // Create download link
                        const link = document.createElement('a');
                        link.href = blobUrl;
                        link.download = filename;
                        link.style.display = 'none';
                        
                        document.body.appendChild(link);
                        log('üìé Download link created and added to DOM', 'success');
                        
                        link.click();
                        log('üëÜ Download link clicked', 'success');
                        
                        document.body.removeChild(link);
                        log('üßπ Download link removed from DOM', 'success');
                        
                        // Clean up blob URL after a delay
                        setTimeout(() => {
                            URL.revokeObjectURL(blobUrl);
                            log('üóëÔ∏è Blob URL revoked', 'success');
                        }, 1000);
                        
                        log('‚úÖ Method 1: Blob download completed successfully', 'success');
                    } else {
                        log('‚ùå Method 1 failed: Empty blob received (0 bytes)', 'error');
                    }
                } else {
                    log(`‚ùå Method 1 failed: HTTP ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Method 1 failed with error: ${error.message}`, 'error');
            }
        }
        
        // Method 2: Direct window.location.href
        async function testMethod2() {
            log('üîÑ Testing Method 2: Direct navigation...', 'info');
            try {
                window.location.href = downloadUrl;
                log('‚úÖ Method 2: Direct navigation initiated', 'success');
            } catch (error) {
                log(`‚ùå Method 2 failed: ${error.message}`, 'error');
            }
        }
        
        // Method 3: window.open()
        async function testMethod3() {
            log('üîÑ Testing Method 3: Window.open...', 'info');
            try {
                const newWindow = window.open(downloadUrl, '_blank');
                if (newWindow) {
                    log('‚úÖ Method 3: New window opened', 'success');
                    setTimeout(() => {
                        try {
                            newWindow.close();
                            log('üîí Popup window closed', 'success');
                        } catch (e) {
                            log('Note: Could not close popup window (normal in many browsers)', 'info');
                        }
                    }, 3000);
                } else {
                    log('‚ùå Method 3 failed: Popup blocked or window creation failed', 'error');
                }
            } catch (error) {
                log(`‚ùå Method 3 failed: ${error.message}`, 'error');
            }
        }
        
        // Method 4: Programmatic anchor tag
        async function testMethod4() {
            log('üîÑ Testing Method 4: Anchor tag approach...', 'info');
            try {
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.target = '_blank';
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                log('üìé Anchor tag created and added to DOM', 'success');
                
                link.click();
                log('üëÜ Anchor tag clicked', 'success');
                
                setTimeout(() => {
                    try {
                        document.body.removeChild(link);
                        log('üßπ Anchor tag removed from DOM', 'success');
                    } catch (e) {
                        log('Note: Anchor tag already removed', 'info');
                    }
                }, 1000);
                
                log('‚úÖ Method 4: Anchor tag approach completed', 'success');
            } catch (error) {
                log(`‚ùå Method 4 failed: ${error.message}`, 'error');
            }
        }
        
        // Method 5: Hidden iframe
        async function testMethod5() {
            log('üîÑ Testing Method 5: Hidden iframe...', 'info');
            try {
                const iframe = document.createElement('iframe');
                iframe.src = downloadUrl;
                iframe.style.display = 'none';
                iframe.style.width = '0';
                iframe.style.height = '0';
                
                document.body.appendChild(iframe);
                log('üñºÔ∏è Hidden iframe created and added', 'success');
                
                setTimeout(() => {
                    try {
                        document.body.removeChild(iframe);
                        log('üßπ Hidden iframe removed', 'success');
                    } catch (e) {
                        log('Note: Iframe already removed', 'info');
                    }
                }, 5000);
                
                log('‚úÖ Method 5: Hidden iframe approach completed', 'success');
            } catch (error) {
                log(`‚ùå Method 5 failed: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        log('üîß Excel Download Test Suite initialized', 'success');
        log(`üì° Test URL: ${downloadUrl}`, 'info');
        log(`üìÑ Expected filename: ${filename}`, 'info');
    </script>
</body>
</html>
